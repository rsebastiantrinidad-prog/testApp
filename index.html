<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprint Management MVP</title>

    <!-- Tailwind CSS desde CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Supabase JS desde CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Estilos personalizados adicionales */
        .tab-active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
        }
        .status-cell {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .status-cell:hover {
            transform: scale(1.1);
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Header Principal -->
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold">üìä Sprint Management MVP</h1>
            <p class="text-blue-100 mt-1">Gesti√≥n de sprints con seguimiento diario</p>
        </div>
    </header>

    <!-- Navegaci√≥n por Tabs -->
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-4">
            <div class="flex space-x-8">
                <button
                    id="tab-backlog"
                    class="py-4 px-6 font-semibold text-gray-600 hover:text-blue-600 transition tab-active"
                    onclick="showTab('backlog')">
                    üìã Backlog
                </button>
                <button
                    id="tab-sprint"
                    class="py-4 px-6 font-semibold text-gray-600 hover:text-blue-600 transition"
                    onclick="showTab('sprint')">
                    üöÄ Sprint Actual
                </button>
            </div>
        </div>
    </nav>

    <!-- Contenedor Principal -->
    <main class="container mx-auto px-4 py-8">

        <!-- ========================================== -->
        <!-- VISTA: BACKLOG -->
        <!-- ========================================== -->
        <div id="view-backlog" class="space-y-6">

            <!-- Bot√≥n Agregar Tarea -->
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">Backlog de Tareas</h2>
                <button
                    onclick="addTask()"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition">
                    ‚ûï Agregar Tarea
                </button>
            </div>

            <!-- Lista de Tareas del Backlog -->
            <div id="backlog-list" class="space-y-3">
                <!-- Las tareas se cargar√°n aqu√≠ din√°micamente -->
            </div>

        </div>

        <!-- ========================================== -->
        <!-- VISTA: SPRINT ACTUAL -->
        <!-- ========================================== -->
        <div id="view-sprint" class="space-y-6 hidden">

            <h2 class="text-2xl font-bold text-gray-800">Sprint Actual - Seguimiento Diario</h2>

            <!-- Tabla de Sprint -->
            <div class="bg-white rounded-lg shadow-lg overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider">
                                Tarea
                            </th>
                            <th class="px-4 py-4 text-center text-sm font-bold text-gray-700 uppercase tracking-wider">
                                D√≠a 1
                            </th>
                            <th class="px-4 py-4 text-center text-sm font-bold text-gray-700 uppercase tracking-wider">
                                D√≠a 2
                            </th>
                            <th class="px-4 py-4 text-center text-sm font-bold text-gray-700 uppercase tracking-wider">
                                D√≠a 3
                            </th>
                            <th class="px-4 py-4 text-center text-sm font-bold text-gray-700 uppercase tracking-wider">
                                D√≠a 4
                            </th>
                            <th class="px-4 py-4 text-center text-sm font-bold text-gray-700 uppercase tracking-wider">
                                D√≠a 5
                            </th>
                            <th class="px-4 py-4 text-center text-sm font-bold text-gray-700 uppercase tracking-wider">
                                D√≠a 6
                            </th>
                        </tr>
                    </thead>
                    <tbody id="sprint-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Las filas se cargar√°n aqu√≠ din√°micamente -->
                    </tbody>
                </table>
            </div>

            <!-- Leyenda -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Leyenda de Estados</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="flex items-center space-x-2">
                        <span class="text-3xl">‚ö™</span>
                        <span class="text-gray-700">Sin actualizar</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-3xl">üü¢</span>
                        <span class="text-gray-700">Todo OK</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-3xl">üü°</span>
                        <span class="text-gray-700">Con dificultad</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-3xl">üî¥</span>
                        <span class="text-gray-700">Bloqueado</span>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mt-3">
                    üí° Haz click en cualquier celda para cambiar el estado
                </p>
            </div>

        </div>

    </main>

    <!-- ========================================== -->
    <!-- JAVASCRIPT -->
    <!-- ========================================== -->
    <script>
        // =====================================================
        // CONFIGURACI√ìN DE SUPABASE
        // =====================================================
        // IMPORTANTE: Reemplaza estos valores con tus credenciales de Supabase
        // 1. Ve a tu proyecto en Supabase: https://app.supabase.com
        // 2. Ve a Settings > API
        // 3. Copia "Project URL" y p√©gala en SUPABASE_URL
        // 4. Copia "anon public" key y p√©gala en SUPABASE_ANON_KEY

        const SUPABASE_URL = 'https://zaziglowjqzbbswevpzq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InphemlnbG93anF6YmJzd2V2cHpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTk1MzcsImV4cCI6MjA3ODE5NTUzN30.3KvwJip5VMXdDxb_BcLP0p7OgIv4AqI7exsCYyApOyI';

        // Inicializar cliente de Supabase
        // IMPORTANTE: Usamos window.supabase porque el CDN expone la librer√≠a en el objeto window
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // =====================================================
        // MAPEO DE COLORES A EMOJIS
        // =====================================================
        const COLOR_EMOJIS = {
            'gray': '‚ö™',
            'green': 'üü¢',
            'yellow': 'üü°',
            'red': 'üî¥'
        };

        // Ciclo de colores: gray ‚Üí green ‚Üí yellow ‚Üí red ‚Üí gray
        const COLOR_CYCLE = ['gray', 'green', 'yellow', 'red'];

        // =====================================================
        // FUNCI√ìN: Obtener el siguiente color en el ciclo
        // =====================================================
        function getNextColor(currentColor) {
            const currentIndex = COLOR_CYCLE.indexOf(currentColor);
            const nextIndex = (currentIndex + 1) % COLOR_CYCLE.length;
            return COLOR_CYCLE[nextIndex];
        }

        // =====================================================
        // FUNCI√ìN: Cambiar entre tabs (Backlog / Sprint)
        // =====================================================
        function showTab(tabName) {
            // Ocultar todas las vistas
            document.getElementById('view-backlog').classList.add('hidden');
            document.getElementById('view-sprint').classList.add('hidden');

            // Remover clase activa de todos los tabs
            document.getElementById('tab-backlog').classList.remove('tab-active');
            document.getElementById('tab-sprint').classList.remove('tab-active');

            // Mostrar la vista seleccionada y activar el tab
            if (tabName === 'backlog') {
                document.getElementById('view-backlog').classList.remove('hidden');
                document.getElementById('tab-backlog').classList.add('tab-active');
                loadBacklog(); // Cargar datos del backlog
            } else if (tabName === 'sprint') {
                document.getElementById('view-sprint').classList.remove('hidden');
                document.getElementById('tab-sprint').classList.add('tab-active');
                loadSprint(); // Cargar datos del sprint
            }
        }

        // =====================================================
        // FUNCI√ìN: Cargar tareas del backlog
        // =====================================================
        async function loadBacklog() {
            try {
                // Consultar tareas con status='backlog'
                const { data: tasks, error } = await supabase
                    .from('tasks')
                    .select('*')
                    .eq('status', 'backlog')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Renderizar la lista de tareas
                const backlogList = document.getElementById('backlog-list');

                if (tasks.length === 0) {
                    backlogList.innerHTML = `
                        <div class="bg-white rounded-lg shadow-md p-8 text-center">
                            <p class="text-gray-500 text-lg">No hay tareas en el backlog</p>
                            <p class="text-gray-400 text-sm mt-2">Agrega una nueva tarea para comenzar</p>
                        </div>
                    `;
                    return;
                }

                backlogList.innerHTML = tasks.map(task => `
                    <div class="bg-white rounded-lg shadow-md p-5 flex justify-between items-center hover:shadow-lg transition">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-800">${task.title}</h3>
                            <p class="text-sm text-gray-500 mt-1">
                                üë§ ${task.assigned_to || 'Sin asignar'}
                                ${task.sprint_number ? `‚Ä¢ Sprint ${task.sprint_number}` : ''}
                            </p>
                        </div>
                        <button
                            onclick="moveToSprint('${task.id}')"
                            class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition">
                            ‚Üí Sprint
                        </button>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error al cargar backlog:', error);
                alert('Error al cargar el backlog. Revisa la consola.');
            }
        }

        // =====================================================
        // FUNCI√ìN: Cargar tareas del sprint actual
        // =====================================================
        async function loadSprint() {
            try {
                // Consultar tareas con status='sprint'
                const { data: tasks, error } = await supabase
                    .from('tasks')
                    .select('*')
                    .eq('status', 'sprint')
                    .order('created_at', { ascending: true });

                if (error) throw error;

                const tableBody = document.getElementById('sprint-table-body');

                if (tasks.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                No hay tareas en el sprint actual. Ve al Backlog para agregar tareas.
                            </td>
                        </tr>
                    `;
                    return;
                }

                // Para cada tarea, obtener sus estados diarios
                const tasksWithStatus = await Promise.all(tasks.map(async (task) => {
                    const { data: statuses, error: statusError } = await supabase
                        .from('daily_status')
                        .select('*')
                        .eq('task_id', task.id);

                    if (statusError) throw statusError;

                    // Crear un mapa de d√≠a ‚Üí color
                    const statusMap = {};
                    statuses.forEach(s => {
                        statusMap[s.day_number] = s.color;
                    });

                    return { ...task, statusMap };
                }));

                // Renderizar las filas de la tabla
                tableBody.innerHTML = tasksWithStatus.map(task => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">${task.title}</div>
                            <div class="text-xs text-gray-500 mt-1">üë§ ${task.assigned_to || 'Sin asignar'}</div>
                        </td>
                        ${[1, 2, 3, 4, 5, 6].map(day => {
                            const currentColor = task.statusMap[day] || 'gray';
                            const emoji = COLOR_EMOJIS[currentColor];
                            return `
                                <td class="px-4 py-4 text-center">
                                    <span
                                        class="status-cell text-3xl inline-block"
                                        onclick="updateStatus('${task.id}', ${day}, '${currentColor}')"
                                        title="Click para cambiar estado">
                                        ${emoji}
                                    </span>
                                </td>
                            `;
                        }).join('')}
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error al cargar sprint:', error);
                alert('Error al cargar el sprint. Revisa la consola.');
            }
        }

        // =====================================================
        // FUNCI√ìN: Actualizar estado de una tarea en un d√≠a
        // =====================================================
        async function updateStatus(taskId, dayNumber, currentColor) {
            try {
                // Calcular el siguiente color en el ciclo
                const nextColor = getNextColor(currentColor);

                // Verificar si ya existe un registro para esta tarea y d√≠a
                const { data: existing, error: checkError } = await supabase
                    .from('daily_status')
                    .select('id')
                    .eq('task_id', taskId)
                    .eq('day_number', dayNumber)
                    .maybeSingle(); // Usar maybeSingle() en lugar de single() para evitar error si no existe

                if (checkError) throw checkError;

                if (existing) {
                    // Ya existe: hacer UPDATE
                    const { error: updateError } = await supabase
                        .from('daily_status')
                        .update({
                            color: nextColor,
                            updated_at: new Date().toISOString()
                        })
                        .eq('task_id', taskId)
                        .eq('day_number', dayNumber);

                    if (updateError) throw updateError;
                } else {
                    // No existe: hacer INSERT
                    const { error: insertError } = await supabase
                        .from('daily_status')
                        .insert({
                            task_id: taskId,
                            day_number: dayNumber,
                            color: nextColor,
                            updated_at: new Date().toISOString()
                        });

                    if (insertError) throw insertError;
                }

                // Recargar la vista del sprint para mostrar el cambio
                loadSprint();

            } catch (error) {
                console.error('Error al actualizar estado:', error);
                alert('Error al actualizar el estado. Revisa la consola.');
            }
        }

        // =====================================================
        // FUNCI√ìN: Mover tarea del backlog al sprint
        // =====================================================
        async function moveToSprint(taskId) {
            try {
                // Actualizar el status de la tarea a 'sprint'
                const { error } = await supabase
                    .from('tasks')
                    .update({ status: 'sprint' })
                    .eq('id', taskId);

                if (error) throw error;

                // Recargar el backlog
                loadBacklog();

                // Mostrar mensaje de √©xito
                alert('‚úÖ Tarea movida al sprint exitosamente');

            } catch (error) {
                console.error('Error al mover tarea al sprint:', error);
                alert('Error al mover la tarea. Revisa la consola.');
            }
        }

        // =====================================================
        // FUNCI√ìN: Agregar nueva tarea al backlog
        // =====================================================
        async function addTask() {
            // Solicitar datos de la tarea mediante prompts simples
            const title = prompt('T√≠tulo de la tarea:');
            if (!title) return; // Cancelado o vac√≠o

            const assignedTo = prompt('Asignado a (opcional):');

            const sprintNumberStr = prompt('N√∫mero de sprint (opcional, default: 1):');
            const sprintNumber = sprintNumberStr ? parseInt(sprintNumberStr) : 1;

            try {
                // Insertar la nueva tarea en la base de datos
                const { error } = await supabase
                    .from('tasks')
                    .insert({
                        title: title.trim(),
                        assigned_to: assignedTo ? assignedTo.trim() : null,
                        sprint_number: sprintNumber,
                        status: 'backlog'
                    });

                if (error) throw error;

                // Recargar el backlog para mostrar la nueva tarea
                loadBacklog();

                alert('‚úÖ Tarea agregada exitosamente');

            } catch (error) {
                console.error('Error al agregar tarea:', error);
                alert('Error al agregar la tarea. Revisa la consola.');
            }
        }

        // =====================================================
        // INICIALIZACI√ìN AL CARGAR LA P√ÅGINA
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar que las credenciales est√©n configuradas
            if (SUPABASE_URL === 'TU_SUPABASE_URL_AQUI' || SUPABASE_ANON_KEY === 'TU_SUPABASE_ANON_KEY_AQUI') {
                alert('‚ö†Ô∏è IMPORTANTE: Debes configurar tus credenciales de Supabase en el archivo index.html\n\nBusca las variables SUPABASE_URL y SUPABASE_ANON_KEY y reempl√°zalas con tus valores reales.');
                return;
            }

            // Cargar la vista de backlog por defecto
            showTab('backlog');
        });

    </script>

</body>
</html>
